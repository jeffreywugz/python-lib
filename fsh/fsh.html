<html>
  <head>
    <title>${path}</title>
    <link rel="stylesheet" type="text/css" href="fsh.css"/>
    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript">
        var path = getQueryArgs().path || '/tmp/scratch';
        document.title = 'fsh: ' + path;
        var py = new pyRpc();
        var popen;

        function load(path){ return py.get(path, {}) || '# use this as scratch';}
        function save(path, content){return py.set(path, content, {});}
        function parse(content, caret){
            [s, e] = [content.lastIndexOf("\n", caret-1), content.indexOf("\n", caret)];
            return content.substring(s+1, e!=-1? e: content.length);
        }
        
        function execute() {
            save(path, $F('content'));
            curLine = parse($F('content'), textAreaGetCaret($('content')));
            popen(curLine);
        }
        
        function initApp() {
            $('content').value = load(path);
            installHotKey(top, 'h', function(w) toggleVisible($('content')));
            installHotKey(top, 'e', function(w) execute());
            popen = installShell(function(expr) py.popen(expr,{}), $('shell'));
            var shell = $('shell');
            $s(shell, 'input').addEventListener('click', function(e) e.ctrlKey && toggleVisible($('content')), false);
        }
    </script>
  </head>
  <body onload="initApp()">
    <textarea name="content" id="content" class="input" style="width:100%;height:25%" onClick="event.ctrlKey && execute()">${content}</textarea>
    <div id="shell"></div>
  </body>
</html>
