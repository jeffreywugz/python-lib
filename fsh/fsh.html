<html>
  <head>
    <title>${path}</title>
    <link rel="stylesheet" type="text/css" href="fsh.css"/>
    <script type="application/javascript;version=1.8" src="common.js"></script>
    <script type="application/javascript;version=1.8">
        var path = getQueryArgs().path || '/tmp/scratch';
        document.title = 'fsh: ' + path;
        var rpc = new ComPyRpc();
        var globalJsTag = '#js:', localJsTag = '#ljs:', jsvTag = /\$jsv(?:{(.+)})?/;
        var handler = function(cmd) rpc.popen(cmd, dirname(path));
        var _jsv_ = "";
        var jobSeqFilter = function(cmd){
            var m = cmd.match(jsvTag);
            if(!m)return [cmd];
            var seq = [parseInt(i)*1000 || i for each(i in (m[1] || _jsv_ || '').split(','))];
            return cmd.seqSub(jsvTag, seq);
        }
        var trivialFilter = function(line, content) [line];
        var _filter_ = jobSeqFilter;

        function filter(line, content, caret) {
            rpc.set(path, content);
            eval(filterLines(content.substring(0, caret), globalJsTag).join(';'));
            eval(filterLine(line, localJsTag));
            if(typeof _filter_ != 'function')_filter_ = jobSeqFilter;
            return _filter_(line, content) || [];
        }
        
        function initApp() {
            var fsh = fish(handler, $('fish'), filter, path);
            fsh('', rpc.get(path));
        }
    </script>
  </head>
  <body onload="initApp()">
    <div id="fish" class="dev">${fish}</div>
  </body>
</html>
