#!/bin/env python2
'''
Expand to multiple cmds and execute one by one
Usages:
 m echo [ {1..3} ]
 m ssh  [ hostname{1,2,3} ] [ uptime date ]
'''
import sys
from subprocess import Popen
try:
    from itertools import product
except Exception, e:
    def product(*iterables, **kwargs):
        if len(iterables) == 0:
            yield ()
        else:
            iterables = iterables * kwargs.get('repeat', 1)
            for item in iterables[0]:
                for items in product(*iterables[1:]):
                    yield (item, ) + items

def cmd_iter(argv):
    last_stat, cur_list = '', []
    for x in argv:
        if last_stat == '[':
            if x == ']': last_stat = ''; yield cur_list
            else: cur_list.append(x)
        else:
            if x == '[':
                last_stat, cur_list = '[', []
            else:
                yield [x]
            
def expand_multi_cmd(argv):
    return product(*list(cmd_iter(argv)))

def sh(argv, cwd=None, timeout=-1):
    return Popen(argv, cwd=cwd).wait()

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print __doc__
        sys.exit(1)
    for cmd in expand_multi_cmd(sys.argv[1:]):
        sys.stderr.write('# %s\n' % (' '.join(cmd)))
        sh(cmd)
